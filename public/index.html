<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskBoard ‚Äî Bom & Alice</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f0f1a;
      --bg-surface: #1a1a2e;
      --bg-hover: #252542;
      --border: #2d2d4a;
      --text: #e4e4ef;
      --text-muted: #8b8ba7;
      --accent: #7c6ff7;
      --accent-hover: #9589f5;
      --urgent: #ef4444;
      --high: #f59e0b;
      --normal: #22c55e;
      --low: #6b7280;
      --bom: #3b82f6;
      --alice: #7c6ff7;
      --project-medspa: #ec4899;
      --project-partnersmemo: #06b6d4;
      --project-personal: #8b5cf6;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .header {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 18px;
    }
    .logo-text h1 { font-size: 18px; font-weight: 600; }
    .logo-text span { font-size: 12px; color: var(--text-muted); }
    .stats { display: flex; gap: 24px; }
    .stat { text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; }
    .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
    .btn {
      background: var(--accent); color: white; border: none; padding: 10px 20px;
      border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; gap: 8px; font-size: 14px; font-family: inherit;
    }
    .btn:hover { background: var(--accent-hover); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-danger { background: var(--urgent); }
    .btn-danger:hover { background: #dc2626; }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-ghost:hover { border-color: var(--accent); color: var(--text); background: transparent; }
    .filters {
      padding: 16px 24px; display: flex; gap: 12px; align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .filter-btn {
      background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-muted);
      padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-family: inherit;
    }
    .filter-btn:hover, .filter-btn.active { border-color: var(--accent); color: var(--text); }
    .board {
      display: flex; gap: 16px; padding: 24px; overflow-x: auto;
      min-height: calc(100vh - 140px);
    }
    .column { min-width: 300px; max-width: 350px; flex: 1; }
    .column-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; background: var(--bg-surface);
      border-radius: 12px 12px 0 0; border: 1px solid var(--border); border-bottom: none;
    }
    .column-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; }
    .column-count {
      background: var(--bg); padding: 2px 8px; border-radius: 12px;
      font-size: 12px; color: var(--text-muted);
    }
    .column-body {
      background: var(--bg-surface); border: 1px solid var(--border); border-top: none;
      border-radius: 0 0 12px 12px; padding: 12px; min-height: 400px;
    }
    .column-body.drag-over { background: var(--bg-hover); }
    .task-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      margin-bottom: 12px; cursor: grab; transition: all 0.2s; position: relative;
      overflow: hidden;
    }
    .task-card:hover { border-color: var(--accent); }
    .task-card.dragging { opacity: 0.5; }
    .task-card.expanded { cursor: default; border-color: var(--accent); }
    .task-card-main { padding: 16px; }
    .task-priority {
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
    }
    .priority-urgent { background: var(--urgent); }
    .priority-high { background: var(--high); }
    .priority-normal { background: var(--normal); }
    .priority-low { background: var(--low); }
    .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .task-title { font-weight: 500; font-size: 14px; line-height: 1.4; flex: 1; }
    .task-actions { display: flex; gap: 4px; }
    .task-action-btn {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      padding: 4px; font-size: 14px; border-radius: 4px; transition: all 0.15s;
    }
    .task-action-btn:hover { color: var(--text); background: var(--bg-hover); }
    .task-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .task-tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 500; }
    .tag-medspa { background: rgba(236, 72, 153, 0.15); color: var(--project-medspa); }
    .tag-partnersmemo { background: rgba(6, 182, 212, 0.15); color: var(--project-partnersmemo); }
    .tag-personal { background: rgba(139, 92, 246, 0.15); color: var(--project-personal); }
    .tag-general { background: rgba(107, 114, 128, 0.15); color: var(--low); }
    .task-assignee {
      width: 24px; height: 24px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; font-size: 10px; font-weight: 600;
    }
    .assignee-bom { background: var(--bom); }
    .assignee-alice { background: var(--alice); }
    .due-badge {
      font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 500;
      display: flex; align-items: center; gap: 3px;
    }
    .due-overdue { background: rgba(239,68,68,0.15); color: var(--urgent); }
    .due-today { background: rgba(245,158,11,0.15); color: var(--high); }
    .due-week { background: rgba(34,197,94,0.15); color: var(--normal); }
    .due-later { background: rgba(107,114,128,0.1); color: var(--text-muted); }

    /* Digest view styles */
    .digest-container { padding: 24px; max-width: 1100px; margin: 0 auto; }
    .digest-header { margin-bottom: 24px; }
    .digest-header h2 { font-size: 22px; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
    .digest-header p { color: var(--text-muted); font-size: 14px; }
    .stat-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
    .stat-card {
      background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 20px; transition: border-color 0.2s, transform 0.2s;
    }
    .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .stat-card-icon { font-size: 24px; margin-bottom: 12px; }
    .stat-card-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .stat-card-label { font-size: 13px; color: var(--text-muted); }
    .stat-card.due-today-card { border-color: var(--high); }
    .stat-card.overdue-card { border-color: var(--urgent); }
    .digest-section { margin-bottom: 28px; }
    .digest-section-title {
      display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600;
      margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
    }
    .digest-section.count-0 { opacity: 0.5; }
    .digest-task-list { display: flex; flex-direction: column; gap: 10px; }
    .digest-task-item {
      background: var(--bg-surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px 16px; display: flex; align-items: center; gap: 12px; transition: border-color 0.2s;
    }
    .digest-task-item:hover { border-color: var(--accent); }
    .digest-task-item.overdue { border-color: var(--urgent); background: rgba(239,68,68,0.05); }
    .digest-task-item.today { border-color: var(--high); background: rgba(245,158,11,0.05); }
    .digest-task-title { flex: 1; font-weight: 500; font-size: 14px; }
    .digest-task-meta { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-muted); }
    .digest-empty { color: var(--text-muted); font-size: 14px; text-align: center; padding: 24px; }
    .team-activity { display: grid; gap: 10px; }
    .activity-row {
      background: var(--bg-surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px 16px; display: flex; align-items: center; gap: 12px;
    }
    .activity-avatar {
      width: 32px; height: 32px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; font-size: 12px; font-weight: 600;
    }
    .activity-avatar.bom { background: var(--bom); }
    .activity-avatar.alice { background: var(--alice); }
    .activity-content { flex: 1; font-size: 14px; }
    .activity-content strong { color: var(--text); }
    .activity-time { font-size: 12px; color: var(--text-muted); }
    @media (max-width: 768px) {
      .stat-cards { grid-template-columns: repeat(2, 1fr); }
      .digest-task-item { flex-wrap: wrap; }
    }

    /* Inline expansion detail panel */
    .task-detail {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease, opacity 0.2s ease;
      opacity: 0; border-top: none;
    }
    .task-detail.open {
      max-height: 800px; opacity: 1; border-top: 1px solid var(--border);
    }
    .task-detail-inner { padding: 16px; }
    .detail-section { margin-bottom: 16px; }
    .detail-section:last-child { margin-bottom: 0; }
    .detail-label {
      font-size: 11px; text-transform: uppercase; color: var(--text-muted);
      margin-bottom: 6px; font-weight: 600;
    }
    .detail-desc {
      font-size: 13px; line-height: 1.6; color: var(--text);
      background: var(--bg-hover); padding: 10px; border-radius: 6px;
      white-space: pre-wrap;
    }
    .activity-item {
      font-size: 12px; color: var(--text-muted); padding: 4px 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-item strong { color: var(--text); }
    .comment-item {
      background: var(--bg-hover); padding: 10px; border-radius: 8px;
      margin-bottom: 8px; font-size: 13px;
    }
    .comment-meta { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .comment-input-row { display: flex; gap: 8px; margin-top: 8px; }
    .comment-input-row input {
      flex: 1; background: var(--bg-hover); border: 1px solid var(--border);
      color: var(--text); padding: 8px 12px; border-radius: 6px; font-size: 13px;
      font-family: inherit;
    }
    .comment-input-row input:focus { outline: none; border-color: var(--accent); }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px;
      width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { font-size: 18px; }
    .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block; font-size: 13px; color: var(--text-muted);
      margin-bottom: 8px; text-transform: uppercase;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      color: var(--text); padding: 12px; border-radius: 8px; font-size: 14px; font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none; border-color: var(--accent);
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .modal-footer {
      padding: 16px 24px; border-top: 1px solid var(--border);
      display: flex; justify-content: flex-end; gap: 12px;
    }
    .btn-secondary { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
    .btn-secondary:hover { background: var(--bg-hover); }
    .loading { display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-muted); }

    /* Archive view */
    .archive-list { padding: 24px; max-width: 900px; margin: 0 auto; }
    .archive-card {
      background: var(--bg-surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px; margin-bottom: 12px; display: flex; align-items: center;
      justify-content: space-between; transition: border-color 0.2s;
    }
    .archive-card:hover { border-color: var(--accent); }
    .archive-info { flex: 1; }
    .archive-title { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
    .archive-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; }

    .quick-add-btn {
      width: 100%; background: transparent; border: 1px dashed var(--border);
      color: var(--text-muted); padding: 10px; border-radius: 8px; cursor: pointer;
      font-size: 13px; font-family: inherit; transition: all 0.2s; margin-top: 4px;
    }
    .quick-add-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(124,111,247,0.05); }
    .quick-add-form {
      background: var(--bg); border: 1px solid var(--accent); border-radius: 8px;
      padding: 12px; margin-top: 4px;
    }
    .quick-add-form input {
      width: 100%; background: var(--bg-hover); border: 1px solid var(--border);
      color: var(--text); padding: 8px 10px; border-radius: 6px; font-size: 13px;
      font-family: inherit; margin-bottom: 8px;
    }
    .quick-add-form input:focus { outline: none; border-color: var(--accent); }
    .quick-add-row { display: flex; gap: 8px; align-items: center; }
    .quick-add-row select {
      background: var(--bg-hover); border: 1px solid var(--border); color: var(--text);
      padding: 6px 8px; border-radius: 6px; font-size: 12px; font-family: inherit;
    }
    .quick-add-row select:focus { outline: none; border-color: var(--accent); }
    .quick-add-hint { font-size: 11px; color: var(--text-muted); margin-left: auto; }

    /* Search bar */
    .search-bar {
      display: flex; align-items: center; position: relative;
    }
    .search-bar input {
      background: var(--bg); border: 1px solid var(--border); color: var(--text);
      padding: 8px 32px 8px 36px; border-radius: 8px; font-size: 14px;
      font-family: inherit; width: 240px; transition: all 0.2s;
    }
    .search-bar input:focus { outline: none; border-color: var(--accent); width: 300px; }
    .search-bar input::placeholder { color: var(--text-muted); }
    .search-icon {
      position: absolute; left: 10px; color: var(--text-muted); font-size: 14px;
      pointer-events: none;
    }
    .search-clear {
      position: absolute; right: 8px; background: none; border: none;
      color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 2px 4px;
      border-radius: 4px; line-height: 1;
    }
    .search-clear:hover { color: var(--text); background: var(--bg-hover); }
    .search-kbd {
      position: absolute; right: 8px; background: var(--bg-hover); color: var(--text-muted);
      font-size: 11px; padding: 1px 6px; border-radius: 4px; border: 1px solid var(--border);
      pointer-events: none; font-family: monospace;
    }
    .search-results {
      font-size: 12px; color: var(--text-muted); margin-left: 8px; white-space: nowrap;
    }
    .task-card.search-hidden { display: none; }

    /* Linked Documents Section */
    .linked-docs-list {
      display: flex; flex-direction: column; gap: 6px;
    }
    .linked-doc-item {
      background: var(--bg-hover); padding: 8px 10px; border-radius: 6;
      display: flex; align-items: center; gap: 8px; font-size: 13px;
      border: 1px solid transparent; transition: border-color 0.2s;
    }
    .linked-doc-item:hover {
      border-color: var(--accent);
    }
    .doc-picker {
      background: var(--bg-hover); border-radius: 6; padding: 8px;
      max-height: 150px; overflow-y: auto; border: 1px solid var(--border);
    }
    .doc-picker-item {
      padding: 6px 8px; cursor: pointer; border-radius: 4;
      font-size: 12px; display: flex; align-items: center; gap: 6px;
      transition: background 0.15s;
    }
    .doc-picker-item:hover {
      background: var(--bg);
    }
    .wiki-link {
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
    }
    .wiki-link:hover {
      color: var(--accent-hover);
    }
    .doc-link-badge {
      background: var(--accent);
      color: white;
      padding: 1px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
    }

    /* ========== MOBILE RESPONSIVE ========== */
    .mobile-column-tabs { display: none; }
    .move-menu {
      position: absolute; right: 8px; top: 40px; z-index: 50;
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 6px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      min-width: 160px; display: none;
    }
    .move-menu.open { display: block; }
    .move-menu button {
      display: flex; align-items: center; gap: 8px; width: 100%;
      background: none; border: none; color: var(--text); padding: 10px 12px;
      font-size: 14px; cursor: pointer; border-radius: 6px; font-family: inherit;
      min-height: 44px; text-align: left;
    }
    .move-menu button:hover, .move-menu button:active { background: var(--bg-hover); }
    .move-menu button.current { color: var(--accent); font-weight: 600; }

    @media (max-width: 768px) {
      .header { flex-wrap: wrap; gap: 10px; padding: 12px 16px; }
      .header .logo { flex: 1; min-width: 120px; }
      .header .stats { gap: 16px; order: 3; width: 100%; justify-content: space-around; padding-top: 10px; border-top: 1px solid var(--border); }
      .stat-value { font-size: 18px; }
      .header > div:last-child { order: 2; flex-wrap: wrap; gap: 6px; }
      .header > div:last-child > div { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .header > div:last-child button { min-height: 44px; }

      .filters { overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 10px 16px; gap: 8px; flex-wrap: nowrap; }
      .filter-btn { white-space: nowrap; min-height: 44px; padding: 10px 16px; }

      .search-bar input { width: 160px; font-size: 16px; }
      .search-bar input:focus { width: 200px; }

      .mobile-column-tabs {
        display: flex !important; overflow-x: auto; -webkit-overflow-scrolling: touch;
        gap: 0; padding: 0 16px; background: var(--bg-surface);
        border-bottom: 1px solid var(--border);
      }
      .mobile-column-tab {
        flex: none; padding: 12px 16px; border: none; background: none;
        color: var(--text-muted); font-size: 13px; font-weight: 500;
        cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent;
        font-family: inherit; min-height: 44px; transition: all 0.2s;
      }
      .mobile-column-tab.active { color: var(--text); border-bottom-color: var(--accent); }
      .mobile-column-tab .tab-count {
        background: var(--bg); padding: 1px 6px; border-radius: 8px;
        font-size: 11px; margin-left: 6px;
      }

      .board { flex-direction: column; padding: 12px 16px; gap: 0; min-height: auto; overflow-x: hidden; }
      .column { min-width: 100%; max-width: 100%; width: 100%; }
      .column.mobile-hidden { display: none; }
      .column-header { display: none; }
      .column-body { border-radius: 12px; border: none; background: transparent; padding: 0; min-height: 120px; }

      .task-card { margin-bottom: 10px; }
      .task-card-main { padding: 16px; min-height: 44px; }
      .task-action-btn { padding: 10px; font-size: 18px; min-width: 44px; min-height: 44px; }
      .task-title { font-size: 15px; }
      .task-tag { font-size: 12px; padding: 4px 10px; }
      .task-assignee { width: 28px; height: 28px; font-size: 11px; }

      .modal { width: 100%; max-width: 100%; border-radius: 16px 16px 0 0; max-height: 95vh; }
      .modal-overlay { align-items: flex-end; }
      .form-row { grid-template-columns: 1fr; }
      .form-group input, .form-group textarea, .form-group select { min-height: 44px; font-size: 16px; }

      .archive-card { flex-direction: column; align-items: flex-start; gap: 12px; }
      .archive-card > div:last-child { width: 100%; display: flex; }
      .archive-card > div:last-child .btn { flex: 1; justify-content: center; min-height: 44px; }

      .comment-input-row input { min-height: 44px; font-size: 16px; }
      .comment-input-row .btn { min-height: 44px; }

      .quick-add-btn { min-height: 44px; }
      .quick-add-form input { min-height: 44px; font-size: 16px; }
      .quick-add-row select { min-height: 44px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;
    
    const API_URL = '';
    const COLUMNS = [
      { id: 'backlog', title: 'Backlog', color: '#6b7280' },
      { id: 'todo', title: 'To Do', color: '#3b82f6' },
      { id: 'in-progress', title: 'In Progress', color: '#f59e0b' },
      { id: 'review', title: 'Review', color: '#8b5cf6' },
      { id: 'done', title: 'Done', color: '#22c55e' }
    ];
    const PROJECTS = ['medspa', 'partnersmemo', 'personal', 'general'];
    const PRIORITIES = ['urgent', 'high', 'normal', 'low'];
    
    function getDueStatus(due_date) {
      if (!due_date) return null;
      const now = new Date();
      now.setHours(0,0,0,0);
      const due = new Date(due_date);
      due.setHours(0,0,0,0);
      const diff = Math.floor((due - now) / (1000*60*60*24));
      if (diff < 0) return { label: 'Overdue', emoji: 'üî¥', cls: 'due-overdue', days: diff };
      if (diff === 0) return { label: 'Today', emoji: 'üü°', cls: 'due-today', days: 0 };
      if (diff <= 7) return { label: `${diff}d`, emoji: 'üü¢', cls: 'due-week', days: diff };
      return { label: due_date.slice(5), emoji: 'üìÖ', cls: 'due-later', days: diff };
    }
    
    function timeAgo(dateStr) {
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      const days = Math.floor(hrs / 24);
      return `${days}d ago`;
    }
    
    function DueBadge({ due_date }) {
      const status = getDueStatus(due_date);
      if (!status) return null;
      return <span className={`due-badge ${status.cls}`}>{status.emoji} {status.label}</span>;
    }
    
    function TaskDetailPanel({ taskId, isOpen, onOpenDocument, allDocs }) {
      const [detail, setDetail] = useState(null);
      const [comments, setComments] = useState([]);
      const [newComment, setNewComment] = useState('');
      const [loading, setLoading] = useState(false);
      const [showDocPicker, setShowDocPicker] = useState(false);
      const [linkedDocs, setLinkedDocs] = useState([]);

      useEffect(() => {
        if (isOpen && taskId) {
          setLoading(true);
          fetch(`/api/tasks/${taskId}`).then(r => r.json()).then(d => {
            setDetail(d);
            setComments(d.comments || []);
            setLinkedDocs(d.linkedDocuments || []);
            setLoading(false);
          });
        }
      }, [isOpen, taskId]);

      const addComment = async () => {
        if (!newComment.trim()) return;
        const res = await fetch(`/api/tasks/${taskId}/comments`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text: newComment, by: 'bom' })
        });
        const comment = await res.json();
        setComments([...comments, comment]);
        setNewComment('');
      };

      const linkDocument = async (doc) => {
        const res = await fetch(`/api/tasks/${taskId}/documents`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ path: doc.path, title: doc.title || doc.slug, type: doc.type || 'other', by: 'bom' })
        });
        if (res.ok) {
          const link = await res.json();
          setLinkedDocs([...linkedDocs, link]);
        }
        setShowDocPicker(false);
      };

      const unlinkDocument = async (docPath) => {
        await fetch(`/api/tasks/${taskId}/documents/${encodeURIComponent(docPath)}?by=bom`, { method: 'DELETE' });
        setLinkedDocs(linkedDocs.filter(d => d.path !== docPath));
      };

      // Parse [[Document Name]] syntax and convert to links
      const renderDescription = (text) => {
        if (!text) return null;
        const parts = [];
        const regex = /\[\[([^\]]+)\]\]/g;
        let lastIndex = 0;
        let match;
        while ((match = regex.exec(text)) !== null) {
          if (match.index > lastIndex) {
            parts.push(text.slice(lastIndex, match.index));
          }
          const docName = match[1];
          // Find matching document
          const matchedDoc = allDocs.find(d =>
            (d.title && d.title.toLowerCase() === docName.toLowerCase()) ||
            d.slug.toLowerCase() === docName.toLowerCase().replace(/\s+/g, '-')
          );
          if (matchedDoc) {
            parts.push(
              <a key={match.index} href="#"
                style={{ color: 'var(--accent)', textDecoration: 'underline', cursor: 'pointer' }}
                onClick={(e) => { e.preventDefault(); onOpenDocument(matchedDoc); }}>
                üìÑ {docName}
              </a>
            );
          } else {
            parts.push(<span key={match.index} style={{ color: 'var(--accent)', opacity: 0.7 }}>[[{docName}]]</span>);
          }
          lastIndex = match.index + match[0].length;
        }
        if (lastIndex < text.length) parts.push(text.slice(lastIndex));
        return parts;
      };

      const availableDocs = allDocs.filter(d => !linkedDocs.some(ld => ld.path === d.path));

      return (
        <div className={`task-detail ${isOpen ? 'open' : ''}`}>
          <div className="task-detail-inner">
            {loading ? <div style={{color:'var(--text-muted)',fontSize:12}}>Loading...</div> : detail && <>
              {detail.description && (
                <div className="detail-section">
                  <div className="detail-label">Description</div>
                  <div className="detail-desc">{renderDescription(detail.description)}</div>
                </div>
              )}

              <div className="detail-section">
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                  <div className="detail-label">üîó Linked Documents ({linkedDocs.length})</div>
                  <button
                    className="btn btn-sm btn-ghost"
                    onClick={() => setShowDocPicker(!showDocPicker)}
                    style={{padding: '4px 10px', fontSize: 11}}>
                    + Link
                  </button>
                </div>
                {showDocPicker && (
                  <div style={{
                    background: 'var(--bg-hover)', borderRadius: 6, padding: 8, marginBottom: 8,
                    maxHeight: 150, overflow: 'auto'
                  }}>
                    {availableDocs.length === 0 ? (
                      <div style={{fontSize: 12, color: 'var(--text-muted)'}}>No available documents</div>
                    ) : (
                      availableDocs.map(doc => (
                        <div key={doc.path} onClick={() => linkDocument(doc)}
                          style={{
                            padding: '6px 8px', cursor: 'pointer', borderRadius: 4,
                            fontSize: 12, display: 'flex', alignItems: 'center', gap: 6
                          }}
                          onMouseOver={e => e.currentTarget.style.background = 'var(--bg)'}
                          onMouseOut={e => e.currentTarget.style.background = 'transparent'}>
                          <span>üìÑ</span>
                          <span>{doc.title || doc.slug}</span>
                          <span style={{color: 'var(--text-muted)', marginLeft: 'auto', fontSize: 10}}>{doc.type || 'other'}</span>
                        </div>
                      ))
                    )}
                  </div>
                )}
                {linkedDocs.length === 0 ? (
                  <div style={{fontSize: 12, color: 'var(--text-muted)'}}>
                    No linked documents. Use [[Document Name]] in description or click + Link
                  </div>
                ) : (
                  <div style={{display: 'flex', flexDirection: 'column', gap: 6}}>
                    {linkedDocs.map(doc => (
                      <div key={doc.path} style={{
                        background: 'var(--bg-hover)', padding: '8px 10px', borderRadius: 6,
                        display: 'flex', alignItems: 'center', gap: 8, fontSize: 13
                      }}>
                        <span>üìÑ</span>
                        <a href="#" style={{ color: 'var(--accent)', flex: 1 }}
                          onClick={(e) => { e.preventDefault(); onOpenDocument(doc); }}>
                          {doc.title || doc.slug}
                        </a>
                        <button onClick={() => unlinkDocument(doc.path)}
                          style={{
                            background: 'none', border: 'none', color: 'var(--text-muted)',
                            cursor: 'pointer', fontSize: 14, padding: 2
                          }}>‚úï</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="detail-section">
                <div className="detail-label">Activity</div>
                {(detail.activity || []).length === 0
                  ? <div style={{fontSize:12,color:'var(--text-muted)'}}>No activity yet</div>
                  : (detail.activity || []).slice(-5).map((a, i) => (
                    <div key={i} className="activity-item">
                      <strong>{a.by}</strong> ‚Äî {a.note} <span style={{float:'right'}}>{timeAgo(a.created_at)}</span>
                    </div>
                  ))
                }
              </div>

              <div className="detail-section">
                <div className="detail-label">Comments ({comments.length})</div>
                {comments.map(c => (
                  <div key={c.id} className="comment-item">
                    {c.text}
                    <div className="comment-meta">{c.by} ¬∑ {timeAgo(c.created_at)}</div>
                  </div>
                ))}
                <div className="comment-input-row">
                  <input
                    placeholder="Add a comment..."
                    value={newComment}
                    onChange={e => setNewComment(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && addComment()}
                  />
                  <button className="btn btn-sm" onClick={addComment}>Send</button>
                </div>
              </div>
            </>}
          </div>
        </div>
      );
    }
    
    function TaskCard({ task, onDragStart, onArchive, fetchData, onMoveTask, onOpenDocument, allDocs }) {
      const [expanded, setExpanded] = useState(false);
      const [moveMenuOpen, setMoveMenuOpen] = useState(false);
      const priorityClass = `priority-${task.priority || 'normal'}`;
      const projectClass = `tag-${task.project}`;

      // Auto-expand if description has [[...]] links
      const hasWikiLinks = task.description && /\[\[[^\]]+\]\]/.test(task.description);

      return (
        <div
          className={`task-card ${expanded ? 'expanded' : ''}`}
          draggable={!expanded}
          onDragStart={(e) => !expanded && onDragStart(e, task)}
        >
          <div className={`task-priority ${priorityClass}`}></div>
          <div className="task-card-main" onClick={() => setExpanded(!expanded)}>
            <div className="task-header">
              <div className="task-title">
                {task.title}
                {hasWikiLinks && <span style={{marginLeft: 4, fontSize: 12}}>üîó</span>}
              </div>
              <div className="task-actions" onClick={e => e.stopPropagation()}>
                <button className="task-action-btn" title="Move to..." onClick={(e) => { e.stopPropagation(); setMoveMenuOpen(!moveMenuOpen); }}>‚ÜóÔ∏è</button>
                <button className="task-action-btn" title="Archive" onClick={onArchive}>üì¶</button>
                {moveMenuOpen && (
                  <div className="move-menu open" onClick={e => e.stopPropagation()}>
                    {COLUMNS.map(col => (
                      <button key={col.id} className={task.status === col.id ? 'current' : ''} onClick={() => { if (task.status !== col.id) onMoveTask(task.id, col.id); setMoveMenuOpen(false); }}>
                        <span style={{width:8,height:8,borderRadius:'50%',background:col.color,display:'inline-block'}}></span>
                        {col.title}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <div className="task-meta">
              <span className={`task-tag ${projectClass}`}>{task.project}</span>
              <DueBadge due_date={task.due_date} />
              <div style={{flex:1}}></div>
              <div className={`task-assignee assignee-${task.assignee}`}>
                {task.assignee === 'bom' ? 'B' : 'A'}
              </div>
            </div>
          </div>
          <TaskDetailPanel taskId={task.id} isOpen={expanded} onOpenDocument={onOpenDocument} allDocs={allDocs} />
        </div>
      );
    }
    
    function TaskModal({ task, onClose, onSubmit }) {
      const [formData, setFormData] = useState({
        title: task?.title || '',
        description: task?.description || '',
        project: task?.project || 'general',
        priority: task?.priority || 'normal',
        assignee: task?.assignee || 'bom',
        due_date: task?.due_date || ''
      });
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit({ ...formData, due_date: formData.due_date || null });
      };
      
      return (
        <div className="modal-overlay active" onClick={(e) => e.target === e.currentTarget && onClose()}>
          <div className="modal">
            <div className="modal-header">
              <h2>{task ? 'Edit Task' : 'New Task'}</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label>Title</label>
                  <input type="text" value={formData.title}
                    onChange={e => setFormData({...formData, title: e.target.value})}
                    placeholder="What needs to be done?" required />
                </div>
                <div className="form-group">
                  <label>Description</label>
                  <textarea value={formData.description}
                    onChange={e => setFormData({...formData, description: e.target.value})}
                    placeholder="Add details..." />
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label>Project</label>
                    <select value={formData.project}
                      onChange={e => setFormData({...formData, project: e.target.value})}>
                      {PROJECTS.map(p => <option key={p} value={p}>{p}</option>)}
                    </select>
                  </div>
                  <div className="form-group">
                    <label>Priority</label>
                    <select value={formData.priority}
                      onChange={e => setFormData({...formData, priority: e.target.value})}>
                      {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                    </select>
                  </div>
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label>Assignee</label>
                    <select value={formData.assignee}
                      onChange={e => setFormData({...formData, assignee: e.target.value})}>
                      <option value="bom">Bom</option>
                      <option value="alice">Alice</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label>Due Date</label>
                    <input type="date" value={formData.due_date}
                      onChange={e => setFormData({...formData, due_date: e.target.value})} />
                  </div>
                </div>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn">{task ? 'Save Changes' : 'Create Task'}</button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    function ArchivePanel() {
      const [archived, setArchived] = useState([]);
      const [loading, setLoading] = useState(true);
      
      const fetchArchived = () => {
        fetch('/api/archived').then(r => r.json()).then(d => { setArchived(d); setLoading(false); });
      };
      useEffect(fetchArchived, []);
      
      const restore = async (id) => {
        await fetch(`/api/tasks/${id}/restore`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: '{}' });
        fetchArchived();
      };
      
      const deletePerm = async (id) => {
        if (!confirm('Permanently delete this task?')) return;
        await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
        fetchArchived();
      };
      
      if (loading) return <div className="loading">Loading archive...</div>;
      
      return (
        <div className="archive-list">
          <h2 style={{marginBottom: 24, fontSize: 20}}>üì¶ Archived Tasks</h2>
          {archived.length === 0 
            ? <div style={{color:'var(--text-muted)', textAlign:'center', padding:40}}>No archived tasks</div>
            : archived.map(t => (
              <div key={t.id} className="archive-card">
                <div className="archive-info">
                  <div className="archive-title">{t.title}</div>
                  <div className="archive-meta">
                    <span className={`task-tag tag-${t.project}`}>{t.project}</span>
                    <span>Archived {timeAgo(t.archived_at)}</span>
                    <span>Was: {t.status}</span>
                  </div>
                </div>
                <div style={{display:'flex', gap:8}}>
                  <button className="btn btn-sm btn-ghost" onClick={() => restore(t.id)}>‚ôªÔ∏è Restore</button>
                  <button className="btn btn-sm btn-danger" onClick={() => deletePerm(t.id)}>üóëÔ∏è</button>
                </div>
              </div>
            ))
          }
        </div>
      );
    }
    
    function TeamPanel() {
      const [team, setTeam] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        fetch('/api/team').then(r => r.json()).then(d => { setTeam(d); setLoading(false); });
      }, []);
      if (loading) return <div className="loading">Loading team...</div>;
      const modelShort = (m) => m ? m.split('/').pop() : '?';
      return (
        <div style={{padding: 24, maxWidth: 900, margin: '0 auto'}}>
          <h2 style={{marginBottom: 24, fontSize: 20}}>üë• Team Status</h2>
          <div style={{display: 'grid', gap: 16}}>
            {team.map(member => (
              <div key={member.name} style={{
                background: 'var(--bg-surface)', border: '1px solid var(--border)',
                borderRadius: 12, padding: 20, position: 'relative'
              }}>
                <div style={{position: 'absolute', top: 16, right: 16, width: 10, height: 10, borderRadius: '50%', background: member.status === 'online' ? '#22c55e' : '#ef4444'}}></div>
                <div style={{display: 'flex', alignItems: 'center', gap: 12, marginBottom: 16}}>
                  <span style={{fontSize: 28}}>{member.emoji}</span>
                  <div>
                    <div style={{fontWeight: 600, fontSize: 18}}>{member.name}</div>
                    <div style={{color: 'var(--text-muted)', fontSize: 13}}>Port {member.port} ‚Ä¢ {member.status}</div>
                  </div>
                </div>
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, fontSize: 13}}>
                  <div>
                    <div style={{color: 'var(--text-muted)', marginBottom: 4, textTransform: 'uppercase', fontSize: 11}}>Primary Model</div>
                    <div style={{background: 'var(--bg)', padding: '6px 10px', borderRadius: 6, fontFamily: 'monospace', fontSize: 12}}>
                      {modelShort(member.model)}
                      {member.runtimeOverride && <span style={{color: 'var(--high)', marginLeft: 6, fontSize: 10}}>RUNTIME</span>}
                    </div>
                  </div>
                  <div>
                    <div style={{color: 'var(--text-muted)', marginBottom: 4, textTransform: 'uppercase', fontSize: 11}}>Cron Model</div>
                    <div style={{background: 'var(--bg)', padding: '6px 10px', borderRadius: 6, fontFamily: 'monospace', fontSize: 12}}>
                      {member.cronModel || 'default'}
                    </div>
                  </div>
                </div>
                {member.fallbacks?.length > 0 && (
                  <div style={{marginTop: 12}}>
                    <div style={{color: 'var(--text-muted)', fontSize: 11, textTransform: 'uppercase', marginBottom: 4}}>Fallbacks</div>
                    <div style={{display: 'flex', gap: 6, flexWrap: 'wrap'}}>
                      {member.fallbacks.map((fb, i) => (
                        <span key={i} style={{background: 'var(--bg)', padding: '3px 8px', borderRadius: 4, fontSize: 11, fontFamily: 'monospace'}}>
                          {modelShort(fb)}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }
    
    function formatRelativeDate(dateStr) {
      if (!dateStr) return '';
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const date = new Date(dateStr);
      date.setHours(0, 0, 0, 0);
      const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Yesterday';
      if (diff < 0) return `In ${Math.abs(diff)} days`;
      return `${diff} days ago`;
    }
    
    function formatRelativeDateTime(dateStr) {
      if (!dateStr) return '';
      const now = Date.now();
      const date = new Date(dateStr).getTime();
      const diff = now - date;
      const mins = Math.floor(diff / 60000);
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      const days = Math.floor(hrs / 24);
      if (days === 1) return 'Yesterday';
      return `${days} days ago`;
    }
    
    function DigestPanel({ tasks }) {
      const [loading, setLoading] = useState(true);
      const [digestData, setDigestData] = useState(null);
      
      useEffect(() => {
        const now = new Date();
        const today = new Date(now);
        today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        const dayAgo = new Date(now);
        dayAgo.setHours(dayAgo.getHours() - 24);
        
        const completedYesterday = tasks.filter(t => {
          if (t.status !== 'done' || !t.updated_at) return false;
          const updated = new Date(t.updated_at);
          return updated >= yesterday && updated < today;
        });
        
        const dueToday = tasks.filter(t => {
          if (t.status === 'done' || !t.due_date) return false;
          const due = new Date(t.due_date);
          due.setHours(0, 0, 0, 0);
          return due.getTime() === today.getTime();
        });
        
        const overdue = tasks.filter(t => {
          if (t.status === 'done' || !t.due_date) return false;
          const due = new Date(t.due_date);
          due.setHours(0, 0, 0, 0);
          return due < today;
        }).sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
        
        const newThisWeek = tasks.filter(t => {
          if (!t.created_at) return false;
          const created = new Date(t.created_at);
          return created >= weekAgo;
        });
        
        const newToday = tasks.filter(t => {
          if (!t.created_at) return false;
          const created = new Date(t.created_at);
          return created >= dayAgo;
        });
        
        // Build activity summary
        const activityMap = new Map();
        tasks.forEach(t => {
          if (t.activity && t.activity.length > 0) {
            t.activity.forEach(a => {
              const key = `${a.by}-${a.note}-${a.created_at}`;
              if (!activityMap.has(key)) {
                activityMap.set(key, { ...a, task: t });
              }
            });
          }
        });
        const recentActivity = Array.from(activityMap.values())
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .slice(0, 10);
        
        setDigestData({
          completedYesterday,
          dueToday,
          overdue,
          newThisWeek,
          newToday,
          recentActivity,
          stats: {
            completedYesterday: completedYesterday.length,
            dueToday: dueToday.length,
            overdue: overdue.length,
            newThisWeek: newThisWeek.length
          }
        });
        setLoading(false);
      }, [tasks]);
      
      if (loading) return <div className="loading">Loading digest...</div>;
      
      const { stats, completedYesterday, dueToday, overdue, newToday, recentActivity } = digestData;
      
      return (
        <div className="digest-container">
          <div className="digest-header">
            <h2>üìä Daily Digest</h2>
            <p>Your task summary at a glance ‚Ä¢ {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
          </div>
          
          <div className="stat-cards">
            <div className="stat-card">
              <div className="stat-card-icon">‚úÖ</div>
              <div className="stat-card-value" style={{color: 'var(--normal)'}}>{stats.completedYesterday}</div>
              <div className="stat-card-label">Completed Yesterday</div>
            </div>
            <div className="stat-card due-today-card">
              <div className="stat-card-icon">üìÖ</div>
              <div className="stat-card-value" style={{color: 'var(--high)'}}>{stats.dueToday}</div>
              <div className="stat-card-label">Due Today</div>
            </div>
            <div className="stat-card overdue-card">
              <div className="stat-card-icon">üî¥</div>
              <div className="stat-card-value" style={{color: 'var(--urgent)'}}>{stats.overdue}</div>
              <div className="stat-card-label">Overdue</div>
            </div>
            <div className="stat-card">
              <div className="stat-card-icon">üÜï</div>
              <div className="stat-card-value" style={{color: 'var(--accent)'}}>{stats.newThisWeek}</div>
              <div className="stat-card-label">New This Week</div>
            </div>
          </div>
          
          {overdue.length > 0 && (
            <div className="digest-section">
              <div className="digest-section-title" style={{color: 'var(--urgent)'}}>
                üî¥ Overdue Tasks <span style={{fontSize: 13, color: 'var(--text-muted)', marginLeft: 8}}>({overdue.length})</span>
              </div>
              <div className="digest-task-list">
                {overdue.map(task => (
                  <div key={task.id} className="digest-task-item overdue">
                    <span className={`task-tag tag-${task.project}`}>{task.project}</span>
                    <span className="digest-task-title">{task.title}</span>
                    <div className="digest-task-meta">
                      <DueBadge due_date={task.due_date} />
                      <span className={`task-assignee assignee-${task.assignee}`} style={{width: 24, height: 24, fontSize: 10}}>
                        {task.assignee === 'bom' ? 'B' : 'A'}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <div className={`digest-section ${dueToday.length === 0 ? 'count-0' : ''}`}>
            <div className="digest-section-title" style={{color: dueToday.length > 0 ? 'var(--high)' : 'var(--text-muted)'}}>
              üìÖ Due Today <span style={{fontSize: 13, color: 'var(--text-muted)', marginLeft: 8}}>({dueToday.length})</span>
            </div>
            {dueToday.length > 0 ? (
              <div className="digest-task-list">
                {dueToday.map(task => (
                  <div key={task.id} className="digest-task-item today">
                    <span className={`task-tag tag-${task.project}`}>{task.project}</span>
                    <span className="digest-task-title">{task.title}</span>
                    <div className="digest-task-meta">
                      <span style={{background: 'rgba(245,158,11,0.15)', color: 'var(--high)', fontSize: 11, padding: '2px 8px', borderRadius: 4, fontWeight: 500}}>Today</span>
                      <span className={`task-assignee assignee-${task.assignee}`} style={{width: 24, height: 24, fontSize: 10}}>
                        {task.assignee === 'bom' ? 'B' : 'A'}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="digest-empty">No tasks due today üéâ</div>
            )}
          </div>
          
          <div className={`digest-section ${completedYesterday.length === 0 ? 'count-0' : ''}`}>
            <div className="digest-section-title">
              ‚úÖ Completed Yesterday <span style={{fontSize: 13, color: 'var(--text-muted)', marginLeft: 8}}>({completedYesterday.length})</span>
            </div>
            {completedYesterday.length > 0 ? (
              <div className="digest-task-list">
                {completedYesterday.map(task => (
                  <div key={task.id} className="digest-task-item">
                    <span className={`task-tag tag-${task.project}`}>{task.project}</span>
                    <span className="digest-task-title" style={{textDecoration: 'line-through', opacity: 0.7}}>{task.title}</span>
                    <div className="digest-task-meta">
                      <span style={{color: 'var(--normal)'}}>‚úì Done</span>
                      <span className={`task-assignee assignee-${task.assignee}`} style={{width: 24, height: 24, fontSize: 10}}>
                        {task.assignee === 'bom' ? 'B' : 'A'}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="digest-empty">No tasks completed yesterday</div>
            )}
          </div>
          
          <div className={`digest-section ${newToday.length === 0 ? 'count-0' : ''}`}>
            <div className="digest-section-title">
              üÜï New in Last 24h <span style={{fontSize: 13, color: 'var(--text-muted)', marginLeft: 8}}>({newToday.length})</span>
            </div>
            {newToday.length > 0 ? (
              <div className="digest-task-list">
                {newToday.map(task => (
                  <div key={task.id} className="digest-task-item">
                    <span className={`task-tag tag-${task.project}`}>{task.project}</span>
                    <span className="digest-task-title">{task.title}</span>
                    <div className="digest-task-meta">
                      <span>{formatRelativeDateTime(task.created_at)}</span>
                      <span className={`task-assignee assignee-${task.assignee}`} style={{width: 24, height: 24, fontSize: 10}}>
                        {task.assignee === 'bom' ? 'B' : 'A'}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="digest-empty">No new tasks created</div>
            )}
          </div>
          
          {recentActivity.length > 0 && (
            <div className="digest-section">
              <div className="digest-section-title">
                üë• Recent Team Activity
              </div>
              <div className="team-activity">
                {recentActivity.map((activity, idx) => (
                  <div key={idx} className="activity-row">
                    <div className={`activity-avatar ${activity.by}`}>
                      {activity.by === 'bom' ? 'B' : 'A'}
                    </div>
                    <div className="activity-content">
                      <strong>{activity.by === 'bom' ? 'Bom' : 'Alice'}</strong> {activity.note}
                      {activity.task && <span style={{color: 'var(--text-muted)'}}> on "{activity.task.title.slice(0, 40)}{activity.task.title.length > 40 ? '...' : ''}"</span>}
                    </div>
                    <div className="activity-time">{formatRelativeDateTime(activity.created_at)}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }
    
    function BrainPanel({ externalDoc, onDocsLoaded, onDocSelect }) {
      const [docs, setDocs] = useState([]);
      const [selected, setSelected] = useState(null);
      const [content, setContent] = useState('');
      const [loading, setLoading] = useState(true);
      const [docLinks, setDocLinks] = useState({});

      useEffect(() => {
        Promise.all([
          fetch('/api/brain/documents').then(r => r.json()),
          fetch('/api/task-documents').then(r => r.json())
        ]).then(([docsData, linksData]) => {
          setDocs(docsData);
          setDocLinks(linksData);
          setLoading(false);
          onDocsLoaded && onDocsLoaded(docsData);
        });
      }, []);

      // Handle external document selection (from task panel)
      useEffect(() => {
        if (externalDoc) {
          loadDoc(externalDoc);
          onDocSelect && onDocSelect();
        }
      }, [externalDoc]);

      const loadDoc = async (doc) => {
        const typePath = doc.path.split('/')[0];
        const res = await fetch(`/api/brain/documents/${typePath}/${doc.slug}`);
        const data = await res.json();
        setContent(data.content); setSelected(doc);
      };

      if (loading) return <div className="loading">Loading brain...</div>;

      const grouped = docs.reduce((acc, d) => {
        const type = d.type || d.path.split('/')[0] || 'other';
        if (!acc[type]) acc[type] = [];
        acc[type].push(d);
        return acc;
      }, {});

      if (selected) {
        const links = docLinks[selected.path];
        return (
          <div style={{padding: 24, maxWidth: 800, margin: '0 auto'}}>
            <button onClick={() => setSelected(null)} style={{background: 'var(--bg-surface)', border: '1px solid var(--border)', color: 'var(--text)', padding: '8px 16px', borderRadius: 6, cursor: 'pointer', marginBottom: 16}}>‚Üê Back</button>
            <div style={{background: 'var(--bg-surface)', border: '1px solid var(--border)', borderRadius: 12, padding: 24}}>
              <h2 style={{marginBottom: 8}}>{selected.title || selected.slug}</h2>
              <div style={{color: 'var(--text-muted)', fontSize: 13, marginBottom: 16, display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap'}}>
                <span>{selected.date} ‚Ä¢ {selected.wordCount} words</span>
                {links && links.count > 0 && (
                  <span style={{
                    background: 'var(--accent)', color: 'white', padding: '2px 8px',
                    borderRadius: 12, fontSize: 11, fontWeight: 600
                  }}>
                    üîó {links.count} linked task{links.count > 1 ? 's' : ''}
                  </span>
                )}
              </div>
              {links && links.count > 0 && (
                <div style={{marginBottom: 16, padding: 12, background: 'var(--bg)', borderRadius: 8}}>
                  <div style={{fontSize: 11, color: 'var(--text-muted)', marginBottom: 6, textTransform: 'uppercase'}}>Linked Tasks</div>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: 6}}>
                    {links.tasks.map(t => (
                      <span key={t.id} style={{
                        fontSize: 12, background: 'var(--bg-surface)', padding: '3px 10px',
                        borderRadius: 4, border: '1px solid var(--border)'
                      }}>
                        {t.title}
                      </span>
                    ))}
                  </div>
                </div>
              )}
              <pre style={{whiteSpace: 'pre-wrap', fontFamily: 'Inter, sans-serif', fontSize: 14, lineHeight: 1.7, color: 'var(--text)'}}>{content.replace(/^---[\s\S]*?---\n/, '')}</pre>
            </div>
          </div>
        );
      }

      return (
        <div style={{padding: 24, maxWidth: 900, margin: '0 auto'}}>
          <h2 style={{marginBottom: 24, fontSize: 20}}>üß† Second Brain</h2>
          {Object.entries(grouped).map(([type, typeDocs]) => (
            <div key={type} style={{marginBottom: 24}}>
              <h3 style={{fontSize: 14, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: 12}}>{type}</h3>
              <div style={{display: 'grid', gap: 12}}>
                {typeDocs.map(doc => {
                  const links = docLinks[doc.path];
                  return (
                    <div key={doc.path} onClick={() => loadDoc(doc)} style={{
                      background: 'var(--bg-surface)', border: '1px solid var(--border)', borderRadius: 10,
                      padding: 16, cursor: 'pointer', transition: 'border-color 0.2s'
                    }} onMouseOver={e => e.currentTarget.style.borderColor = 'var(--accent)'} onMouseOut={e => e.currentTarget.style.borderColor = 'var(--border)'}>
                      <div style={{display: 'flex', alignItems: 'center', gap: 8}}>
                        <span style={{fontWeight: 500}}>{doc.title || doc.slug}</span>
                        {links && links.count > 0 && (
                          <span style={{
                            background: 'var(--accent)', color: 'white', padding: '1px 6px',
                            borderRadius: 10, fontSize: 10, fontWeight: 600
                          }}>
                            {links.count}
                          </span>
                        )}
                      </div>
                      <div style={{fontSize: 12, color: 'var(--text-muted)'}}>{doc.date} ‚Ä¢ {doc.wordCount} words</div>
                      <div style={{fontSize: 13, color: 'var(--text-muted)', marginTop: 8, lineHeight: 1.5}}>{doc.preview?.slice(0, 150)}...</div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      );
    }
    
    function QuickAddForm({ status, onSave, onCancel }) {
      const [title, setTitle] = useState('');
      const [priority, setPriority] = useState('normal');
      const inputRef = useRef(null);
      useEffect(() => { inputRef.current?.focus(); }, []);
      const handleSubmit = async () => {
        if (!title.trim()) return;
        await onSave({ title: title.trim(), priority, status, project: 'general', assignee: 'bom' });
        setTitle(''); setPriority('normal');
      };
      const handleKeyDown = (e) => {
        if (e.key === 'Enter') { e.preventDefault(); handleSubmit(); }
        if (e.key === 'Escape') onCancel();
      };
      return (
        <div className="quick-add-form">
          <input ref={inputRef} placeholder="Task title..." value={title}
            onChange={e => setTitle(e.target.value)} onKeyDown={handleKeyDown} />
          <div className="quick-add-row">
            <select value={priority} onChange={e => setPriority(e.target.value)}>
              {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
            </select>
            <button className="btn btn-sm" onClick={handleSubmit}>Add</button>
            <span className="quick-add-hint">‚Üµ save ¬∑ esc cancel</span>
          </div>
        </div>
      );
    }
    
    function App() {
      const [tasks, setTasks] = useState([]);
      const [stats, setStats] = useState({});
      const [loading, setLoading] = useState(true);
      const [modalOpen, setModalOpen] = useState(false);
      const [editingTask, setEditingTask] = useState(null);
      const [draggingTask, setDraggingTask] = useState(null);
      const [filter, setFilter] = useState('all');
      const [view, setView] = useState('board');
      const [quickAddColumn, setQuickAddColumn] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [mobileColumn, setMobileColumn] = useState('todo');
      const [allDocs, setAllDocs] = useState([]);
      const [selectedDoc, setSelectedDoc] = useState(null);
      const searchRef = useRef(null);
      
      const fetchData = useCallback(async () => {
        try {
          const [tasksRes, statsRes] = await Promise.all([
            fetch(`${API_URL}/api/tasks`),
            fetch(`${API_URL}/api/stats`)
          ]);
          setTasks(await tasksRes.json());
          setStats(await statsRes.json());
        } catch (err) { console.error('Failed to fetch:', err); }
        finally { setLoading(false); }
      }, []);
      
      useEffect(() => { fetchData(); }, [fetchData]);
      
      useEffect(() => {
        const handler = (e) => {
          if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
            e.preventDefault();
            searchRef.current?.focus();
          }
          if (e.key === 'Escape' && searchRef.current === document.activeElement) {
            setSearchQuery('');
            searchRef.current.blur();
          }
        };
        document.addEventListener('keydown', handler);
        return () => document.removeEventListener('keydown', handler);
      }, []);
      
      const handleDragStart = (e, task) => {
        setDraggingTask(task);
        e.dataTransfer.effectAllowed = 'move';
      };
      const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
      const handleDrop = async (e, status) => {
        e.preventDefault();
        if (!draggingTask || draggingTask.status === status) return;
        await fetch(`${API_URL}/api/tasks/${draggingTask.id}`, {
          method: 'PATCH', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ status })
        });
        setDraggingTask(null);
        await fetchData();
      };
      
      const handleCreateTask = async (taskData) => {
        await fetch(`${API_URL}/api/tasks`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify(taskData)
        });
        setModalOpen(false);
        await fetchData();
      };
      
      const handleMoveTask = async (taskId, newStatus) => {
        await fetch(`${API_URL}/api/tasks/${taskId}`, {
          method: 'PATCH', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ status: newStatus })
        });
        await fetchData();
      };
      
      const handleArchiveTask = async (taskId) => {
        await fetch(`${API_URL}/api/tasks/${taskId}/archive`, {
          method: 'PATCH', headers: {'Content-Type':'application/json'}, body: '{}'
        });
        await fetchData();
      };
      
      const handleQuickAdd = async (taskData) => {
        await fetch(`${API_URL}/api/tasks`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify(taskData)
        });
        await fetchData();
      };

      const handleOpenDocument = (doc) => {
        setSelectedDoc(doc);
        setView('brain');
      };

      const handleDocsLoaded = (docs) => {
        setAllDocs(docs);
      };

      const handleDocSelected = () => {
        setSelectedDoc(null); // Clear after navigation
      };

      const projectFiltered = filter === 'all' ? tasks : tasks.filter(t => t.project === filter);
      const query = searchQuery.toLowerCase().trim();
      const filteredTasks = query
        ? projectFiltered.filter(t =>
            (t.title || '').toLowerCase().includes(query) ||
            (t.description || '').toLowerCase().includes(query) ||
            (t.project || '').toLowerCase().includes(query) ||
            (t.assignee || '').toLowerCase().includes(query)
          )
        : projectFiltered;
      const tasksByColumn = COLUMNS.reduce((acc, col) => {
        acc[col.id] = filteredTasks.filter(t => t.status === col.id);
        return acc;
      }, {});
      
      if (loading) return <div className="loading">Loading...</div>;
      
      return (
        <>
          <header className="header">
            <div className="logo">
              <div className="logo-icon">TB</div>
              <div className="logo-text">
                <h1>TaskBoard</h1>
                <span>Bom & Alice</span>
              </div>
            </div>
            <div className="stats">
              <div className="stat">
                <div className="stat-value">{stats.total || 0}</div>
                <div className="stat-label">Total</div>
              </div>
              <div className="stat">
                <div className="stat-value" style={{color: 'var(--high)'}}>{stats.in_progress || 0}</div>
                <div className="stat-label">Active</div>
              </div>
              <div className="stat">
                <div className="stat-value" style={{color: 'var(--normal)'}}>{stats.done || 0}</div>
                <div className="stat-label">Done</div>
              </div>
              {stats.archived > 0 && <div className="stat">
                <div className="stat-value" style={{color: 'var(--text-muted)'}}>{stats.archived}</div>
                <div className="stat-label">Archived</div>
              </div>}
            </div>
            <div style={{display: 'flex', gap: 8, alignItems: 'center'}}>
              <div style={{display: 'flex', gap: 4, background: 'var(--bg)', borderRadius: 8, padding: 3}}>
                {[{id:'board',label:'üìã Board'},{id:'digest',label:'üìä Digest'},{id:'archive',label:'üì¶ Archive'},{id:'team',label:'üë• Team'},{id:'brain',label:'üß† Brain'}].map(tab => (
                  <button key={tab.id} onClick={() => setView(tab.id)} style={{
                    background: view === tab.id ? 'var(--accent)' : 'transparent',
                    border: 'none', color: 'var(--text)', padding: '6px 14px', borderRadius: 6,
                    cursor: 'pointer', fontSize: 13, fontWeight: view === tab.id ? 600 : 400, fontFamily: 'inherit'
                  }}>{tab.label}</button>
                ))}
              </div>
              {view === 'board' && <>
                <div className="search-bar">
                  <span className="search-icon">üîç</span>
                  <input
                    ref={searchRef}
                    type="text"
                    placeholder="Search tasks..."
                    value={searchQuery}
                    onChange={e => setSearchQuery(e.target.value)}
                  />
                  {searchQuery
                    ? <button className="search-clear" onClick={() => { setSearchQuery(''); searchRef.current?.focus(); }}>‚úï</button>
                    : <span className="search-kbd">/</span>
                  }
                </div>
                {query && <span className="search-results">{filteredTasks.length} result{filteredTasks.length !== 1 ? 's' : ''}</span>}
                <button className="btn" onClick={() => { setEditingTask(null); setModalOpen(true); }}>+ New Task</button>
              </>}
            </div>
          </header>
          
          {view === 'team' && <TeamPanel />}
          {view === 'brain' && <BrainPanel externalDoc={selectedDoc} onDocsLoaded={handleDocsLoaded} onDocSelect={handleDocSelected} />}
          {view === 'archive' && <ArchivePanel />}
          {view === 'digest' && <DigestPanel tasks={tasks} />}
          {view === 'board' && <>
            <div className="filters">
              <span style={{color: 'var(--text-muted)', fontSize: 14}}>Filter:</span>
              <button className={`filter-btn ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>All</button>
              {PROJECTS.map(p => (
                <button key={p} className={`filter-btn ${filter === p ? 'active' : ''}`} onClick={() => setFilter(p)}>{p}</button>
              ))}
            </div>
            <div className="mobile-column-tabs">
              {COLUMNS.map(col => (
                <button key={col.id} className={`mobile-column-tab ${mobileColumn === col.id ? 'active' : ''}`} onClick={() => setMobileColumn(col.id)}>
                  <span style={{width:6,height:6,borderRadius:'50%',background:col.color,display:'inline-block',marginRight:4}}></span>
                  {col.title}
                  <span className="tab-count">{tasksByColumn[col.id]?.length || 0}</span>
                </button>
              ))}
            </div>
            <div className="board">
              {COLUMNS.map(column => (
                <div key={column.id} className={`column ${mobileColumn !== column.id ? 'mobile-hidden' : ''}`}>
                  <div className="column-header">
                    <div className="column-title">
                      <span style={{width: 8, height: 8, borderRadius: '50%', background: column.color, display: 'inline-block'}}></span>
                      {column.title}
                    </div>
                    <span className="column-count">{tasksByColumn[column.id]?.length || 0}</span>
                  </div>
                  <div className="column-body" onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, column.id)}>
                    {tasksByColumn[column.id]?.map(task => (
                      <TaskCard
                        key={task.id} task={task}
                        onDragStart={handleDragStart}
                        onArchive={() => handleArchiveTask(task.id)}
                        onMoveTask={handleMoveTask}
                        fetchData={fetchData}
                        onOpenDocument={handleOpenDocument}
                        allDocs={allDocs}
                      />
                    ))}
                    {quickAddColumn === column.id
                      ? <QuickAddForm status={column.id} onSave={handleQuickAdd} onCancel={() => setQuickAddColumn(null)} />
                      : <button className="quick-add-btn" onClick={() => setQuickAddColumn(column.id)}>+ Add task</button>
                    }
                  </div>
                </div>
              ))}
            </div>
          </>}
          {modalOpen && (
            <TaskModal
              task={editingTask}
              onClose={() => setModalOpen(false)}
              onSubmit={handleCreateTask}
            />
          )}
        </>
      );
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
